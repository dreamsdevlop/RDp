name: 24/7 Live RDP
# Refreshed to clear stale lints

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  schedule:
    # Re-trigger every 5 hours to maintain 24/7 uptime
    - cron: '0 */5 * * *'

jobs:
  rdp-server:
    runs-on: ubuntu-latest
    timeout-minutes: 350  # Just under 6 hours (GitHub's limit)
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Environment
        run: |
          echo "=== System Information ==="
          uname -a
          echo "=== Available Resources ==="
          nproc
          free -h
          df -h

      - name: ğŸ³ Setup Docker
        run: |
          echo "=== Docker is pre-installed on GitHub runners ==="
          docker --version
          docker compose version
          sudo systemctl start docker
          sudo systemctl enable docker

      - name: ğŸ“¦ Install Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget curl

      - name: ğŸš€ Make Scripts Executable
        run: chmod +x rdp.sh backup.sh

      - name: ğŸŒ Install Cloudflare Tunnel
        run: |
          if [ ! -f "/usr/local/bin/cloudflared" ]; then
            sudo wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O /usr/local/bin/cloudflared
            sudo chmod +x /usr/local/bin/cloudflared
          fi
          cloudflared --version

      - name: ğŸ’¾ Restore Tailscale State
        id: tailscale-cache
        uses: actions/cache@v3
        with:
          path: /var/lib/tailscale
          key: tailscale-state-live
          restore-keys: |
            tailscale-state-live

      - name: ğŸ” Install and Setup Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          echo "=== Installing Tailscale ==="
          curl -fsSL https://tailscale.com/install.sh | sh
          
          echo "=== Starting Tailscale Daemon ==="
          sudo mkdir -p /var/lib/tailscale
          sudo tailscaled --state=/var/lib/tailscale/tailscaled.state &
          sleep 3
          
          echo "=== Connecting to Tailscale Network ==="
          # Note: You need to set TAILSCALE_AUTH_KEY in repository secrets
          # Go to: Settings â†’ Secrets â†’ Actions â†’ New repository secret
          # Get auth key from: https://login.tailscale.com/admin/settings/keys
          if [ -n "$TAILSCALE_AUTH_KEY" ]; then
            if sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="github-rdp-live" --ssh; then
              echo "âœ… Tailscale connected successfully!"
              TAILSCALE_IP=$(tailscale ip -4)
              echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
              echo "ğŸ” Tailscale IP: $TAILSCALE_IP"
            else
              echo "âš ï¸ Tailscale authentication failed (invalid or expired key)."
              echo "   Generate new key: https://login.tailscale.com/admin/settings/keys"
              echo "   Update secret: https://github.com/dreamsdevlop/RDp/settings/secrets/actions"
              echo "   Continuing without Tailscale (Cloudflare tunnels still work)"
            fi
          else
            echo "âš ï¸ TAILSCALE_AUTH_KEY not set in repository secrets"
            echo "   Tailscale will not be activated (Cloudflare tunnels will still work)"
            echo "   To enable Tailscale:"
            echo "   1. Get auth key from: https://login.tailscale.com/admin/settings/keys"
            echo "   2. Add to: Settings â†’ Secrets â†’ Actions â†’ TAILSCALE_AUTH_KEY"
          fi

      - name: ğŸ–¥ï¸ Deploy Windows 11 RDP
        run: |
          echo "=== Starting RDP Deployment ==="
          sudo bash rdp.sh &
          RDP_PID=$!
          echo "RDP_PID=$RDP_PID" >> $GITHUB_ENV
          
          # Initial wait for services (reduce if too slow)
          echo "â³ Waiting 5 minutes for initial boot..."
          sleep 300
          
          echo "=== Checking Docker Status ==="
          sudo docker ps -a
          
          echo "=== Windows Container Logs (last 20 lines) ==="
          sudo docker logs windows --tail 20 || echo "No logs (container may not be ready)"
          
          echo "=== Host Ports 8006/3389 ==="
          sudo ss -tlnp | grep -E ':(8006|3389)' || echo "No listeners on RDP/NoVNC ports yet - still booting"
          
          echo "=== Checking Cloudflare Tunnels ==="
          sudo cat /var/log/cloudflared_web.log || echo "Web log not found yet"
          sudo cat /var/log/cloudflared_rdp.log || echo "RDP log not found yet"

      - name: ğŸ’¾ Setup Smart Backup (Rclone)
        if: ${{ secrets.RCLONE_CONFIG != '' }}
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
        run: |
          echo "=== Installing Rclone ==="
          sudo -v ; curl https://rclone.org/install.sh | sudo bash
          
          echo "=== Configuring Rclone ==="
          mkdir -p $HOME/.config/rclone
          echo "$RCLONE_CONFIG" > $HOME/.config/rclone/rclone.conf
          
          echo "=== Starting Backup Service ==="
          # Run as root to access the shared volume
          sudo bash backup.sh &
          echo "âœ… Backup service started in background"

      - name: ğŸ“Š Display Access Information
        run: |
          echo "=========================================="
          echo "ğŸ‰ RDP Server is Running!"
          echo "=========================================="
          
          # Extract Cloudflare URLs
          CF_WEB=$(sudo grep -o "https://[a-zA-Z0-9.-]*\.trycloudflare\.com" /var/log/cloudflared_web.log 2>/dev/null | head -n 1 || echo "Initializing...")
          CF_RDP=$(sudo grep -o "tcp://[a-zA-Z0-9.-]*\.trycloudflare\.com:[0-9]*" /var/log/cloudflared_rdp.log 2>/dev/null | head -n 1 || echo "Initializing...")
          
          echo "ğŸŒ Web Console (NoVNC):"
          echo "   $CF_WEB"
          echo ""
          echo "ğŸ–¥ï¸  RDP Access (Cloudflare):"
          echo "   $CF_RDP"
          echo ""
          
          # Display Tailscale IP if available
          if [ -n "$TAILSCALE_IP" ]; then
            echo "ğŸ” RDP Access (Tailscale VPN):"
            echo "   $TAILSCALE_IP:3389"
            echo "   (Connect via Tailscale network)"
            echo ""
          fi
          
          echo "ğŸ”‘ Credentials:"
          echo "   Username: MASTER"
          echo "   Password: admin@123"
          echo "=========================================="
          
          # Save to GitHub Step Summary
          echo "## ğŸ‰ RDP Server Active" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ Web Console (NoVNC)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$CF_WEB" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ–¥ï¸ RDP Access (Cloudflare)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$CF_RDP" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$TAILSCALE_IP" ]; then
            echo "### ğŸ” RDP Access (Tailscale VPN)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$TAILSCALE_IP:3389" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "Connect via Tailscale network for secure VPN access" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### ğŸ”‘ Credentials" >> $GITHUB_STEP_SUMMARY
          echo "- **Username:** MASTER" >> $GITHUB_STEP_SUMMARY
          echo "- **Password:** admin@123" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”„ Keep Alive (Run for ~5.5 hours)
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          echo "=== Entering Keep-Alive Mode ==="
          echo "This will run for approximately 5.5 hours before auto-restart"
          
          END_TIME=$(($(date +%s) + 19800))  # 5.5 hours = 19800 seconds
          
          while [ $(date +%s) -lt $END_TIME ]; do
            # Check if Docker container is running
            if ! sudo docker ps | grep -q windows; then
              echo "âš ï¸ Windows container stopped! Restarting..."
              cd /root/dockercom
              sudo docker compose -f windows.yml up -d
            fi
            
            # Check if Cloudflare tunnels are running
            if ! pgrep -x "cloudflared" > /dev/null; then
              echo "âš ï¸ Cloudflared stopped! Restarting..."
              sudo nohup cloudflared tunnel --url http://localhost:8006 > /var/log/cloudflared_web.log 2>&1 &
              sudo nohup cloudflared tunnel --url tcp://localhost:3389 > /var/log/cloudflared_rdp.log 2>&1 &
            fi
            
            # Check if Tailscale daemon is running
            if ! pgrep -x "tailscaled" > /dev/null; then
              echo "âš ï¸ Tailscale daemon stopped! Restarting..."
              sudo tailscaled --state=/var/lib/tailscale/tailscaled.state &
              sleep 2
              if [ -n "$TAILSCALE_AUTH_KEY" ]; then
                if sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="github-rdp-live" --ssh; then
                  echo "âœ… Tailscale reconnected"
                else
                  echo "âš ï¸ Tailscale reconnect failed, continuing"
                fi
              fi
            fi
            
            # Display status every 10 minutes
            REMAINING=$((($END_TIME - $(date +%s)) / 60))
            echo "âœ… Status: Running | Time remaining: ${REMAINING} minutes"
            
            # Show current connections
            echo "ğŸ“Š Docker Status:"
            sudo docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            # Show Tailscale status if connected
            if pgrep -x "tailscaled" > /dev/null; then
              echo "ğŸ” Tailscale Status:"
              sudo tailscale status || echo "   Not connected"
            fi
            
            sleep 600  # Check every 10 minutes
          done
          
          echo "=== Session ending, workflow will auto-restart via cron ==="

      - name: ğŸ“ Cleanup on Failure
        if: failure()
        run: |
          echo "=== Collecting failure logs ==="
          sudo docker logs windows || true
          sudo cat /var/log/cloudflared_web.log || true
          sudo cat /var/log/cloudflared_rdp.log || true
